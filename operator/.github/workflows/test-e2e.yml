name: E2E Tests

on:
  push:
  pull_request:

jobs:
  test-e2e:
    name: Run on Ubuntu
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Clone the code
        uses: actions/checkout@v4

      - name: Free up disk space
        run: |
          # Remove unused packages BEFORE installing Kind to avoid breaking dependencies
          # Use || true to ignore errors from removing non-existent packages
          sudo apt-get remove -y '^dotnet-.*' '^llvm-.*' '^mongodb-.*' '^mysql-.*' azure-cli google-cloud-sdk hhvm google-chrome-stable firefox powershell mono-devel || true
          sudo apt-get autoremove -y || true
          sudo apt-get clean
          # Show available disk space after cleanup
          df -h

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod

      - name: Install the latest version of kind
        run: |
          curl -Lo ./kind https://kind.sigs.k8s.io/dl/latest/kind-linux-amd64
          chmod +x ./kind
          sudo mv ./kind /usr/local/bin/kind

      - name: Verify kind installation
        run: kind version

      - name: Verify Docker is running
        run: |
          docker --version
          docker ps
          sudo systemctl status docker --no-pager

      - name: Create Kind cluster
        run: |
          # Create a Kind cluster for E2E tests
          kind create cluster --name e2e-test --wait 300s

      - name: Verify cluster connectivity
        run: |
          # Wait for API server to be fully ready
          kubectl cluster-info
          kubectl get nodes
          kubectl wait --for=condition=ready nodes --all --timeout=300s

      - name: Install CRDs
        run: |
          make install

      - name: Create test namespace
        run: |
          kubectl create namespace nephio-intent-operator-system-e2e || true

      - name: Running Test e2e
        run: |
          go mod tidy
          # Run only minimal tests that don't require Docker image build
          go test -tags=e2e ./test/e2e/minimal_e2e_test.go ./test/e2e/minimal_suite_test.go ./test/e2e/minimal_deploy_test.go -v

      - name: Collect debug information
        if: failure()
        run: |
          echo "=== Cluster Info ==="
          kubectl cluster-info || true
          echo "=== Node Status ==="
          kubectl get nodes || true
          echo "=== Pod Status ==="
          kubectl get pods -A || true
          echo "=== Events ==="
          kubectl get events -A || true
          echo "=== Kind clusters ==="
          kind get clusters || true

      - name: Cleanup Kind cluster
        if: always()
        run: |
          echo "Cleaning up Kind cluster..."
          kind delete cluster --name e2e-test || true
