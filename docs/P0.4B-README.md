# P0.4B: VM-2 Manual Deployment - One-Command Fallback Solution

## Overview

The P0.4B script provides a robust, one-command fallback solution for deploying the edge cluster on VM-2 with full GitOps integration to VM-1's Gitea repository. This script is designed to be idempotent, handle errors gracefully, and provide comprehensive health checks throughout the deployment process.

## Quick Deployment

### On VM-2 (172.16.4.45):

```bash
# Clone the repository
git clone https://github.com/thc1006/nephio-intent-to-o2-demo.git
cd nephio-intent-to-o2-demo

# Option 1: Run with interactive token prompt
./scripts/p0.4B_vm2_manual.sh

# Option 2: Run with pre-set token
export GITEA_TOKEN="1b5ea0b27add59e71980ba3f7612a3bfed1487b7"
./scripts/p0.4B_vm2_manual.sh
```

## What It Does

The script automatically:

1. **Installs Prerequisites**
   - Docker, kubectl, kind, jq, yq
   - Verifies all tools are working correctly

2. **Creates Edge Cluster**
   - Kind cluster named "edge1"
   - API server bound to VM-2's IP (172.16.4.45:6443)
   - Proper networking for external access

3. **Installs Config Sync**
   - Google Config Sync operator v1.17.0
   - Full GitOps capabilities for continuous deployment

4. **Configures GitOps Integration**
   - RootSync to VM-1's Gitea repository
   - Token-based authentication
   - 30-second sync interval

5. **Runs Health Checks**
   - Cluster connectivity
   - Config Sync status
   - RootSync synchronization
   - Git repository access
   - Applied resources verification

## Key Features

### Idempotency
- Safe to run multiple times
- Detects existing resources
- Updates configurations without breaking existing deployments

### Error Handling
- Comprehensive error trapping
- Clear error messages with line numbers
- Recovery instructions for common failures
- Detailed logging to `/tmp/p0.4B_vm2_manual_*.log`

### Artifacts
- Saves all deployment artifacts to `./artifacts/p0.4B/`
- Includes cluster info, pod status, sync configurations
- Health check results in JSON format
- Deployment timestamps and markers

## Integration with Existing Setup

This script integrates seamlessly with the existing VM-1 to VM-2 GitOps pipeline:

```
VM-1 (Management/SMO)              VM-2 (Edge/O-Cloud)
┌─────────────────┐                ┌─────────────────┐
│  Intent → KRM   │                │  Edge Cluster   │
│  Transformation │                │    (kind)       │
│     Pipeline    │                │                 │
└────────┬────────┘                └────────▲────────┘
         │                                   │
         │ Git Push                          │ GitOps Pull
         ▼                                   │
    ┌─────────────────────────────────────────┐
    │         Gitea Repository                 │
    │   http://147.251.115.143:8888            │
    │       admin1/edge1-config                │
    └─────────────────────────────────────────┘
```

## Verification

After deployment, verify the setup:

```bash
# On VM-2: Check cluster status
kubectl cluster-info

# Check Config Sync
kubectl get rootsync -n config-management-system

# Watch for synced resources
kubectl get all --all-namespaces -l app.kubernetes.io/managed-by=configmanagement.gke.io

# From VM-1: Push test configuration
cd packages/intent-to-krm
./scripts/push_krm_to_gitea.sh

# On VM-2: Verify deployment
kubectl get all -n edge1
```

## Troubleshooting

### Common Issues and Solutions

1. **Docker Permission Errors**
   ```bash
   sudo usermod -aG docker $USER
   newgrp docker
   ```

2. **Port Conflicts**
   ```bash
   sudo netstat -tlnp | grep 6443
   kind delete cluster --name edge1
   ```

3. **Config Sync Not Ready**
   ```bash
   kubectl logs -n config-management-system -l app=config-management-operator
   kubectl delete pod -n config-management-system -l app=config-management-operator
   ```

4. **RootSync Authentication Failed**
   ```bash
   # Update token
   kubectl delete secret git-creds -n config-management-system
   kubectl create secret generic git-creds \
     --namespace=config-management-system \
     --from-literal=username=admin1 \
     --from-literal=token="NEW_TOKEN"
   ```

## Files and Documentation

- **Script**: `/scripts/p0.4B_vm2_manual.sh`
- **Documentation**: `/docs/VM2-Manual.md`
- **Test Suite**: `/scripts/test_p0.4B.sh`
- **Artifacts**: `./artifacts/p0.4B/`
- **Logs**: `/tmp/p0.4B_vm2_manual_*.log`

## Success Criteria

The deployment is successful when:

- ✅ Edge cluster is running on VM-2
- ✅ Config Sync is operational
- ✅ RootSync shows SYNCED status
- ✅ Resources from Gitea are being deployed
- ✅ Health checks pass without errors

## Next Steps

1. Run the deployment script on VM-2
2. Verify GitOps synchronization
3. Push intent-based KRM configurations from VM-1
4. Monitor automatic deployment to edge cluster
5. Implement O2 IMS provisioning requests

## Support

For issues:
1. Check the log file for detailed error messages
2. Review `/docs/VM2-Manual.md` for comprehensive troubleshooting
3. Run `/scripts/test_p0.4B.sh` to validate script integrity
4. Consult artifacts in `./artifacts/p0.4B/` for deployment state