# P0.4A O-Cloud Provisioning Implementation

## Overview

The P0.4A script implements end-to-end O-Cloud provisioning using the FoCoM operator and O2 IMS APIs. This production-ready implementation follows cloud-native best practices with comprehensive error handling, idempotent operations, and detailed logging.

## Architecture

```
┌────────────────────────────────────────────────┐
│                SMO Cluster (KinD)              │
│                                                │
│  ┌──────────────────────────────────────────┐ │
│  │          FoCoM Operator                  │ │
│  │  ┌────────────────────────────────────┐  │ │
│  │  │  Watches ProvisioningRequest CRs   │  │ │
│  │  └────────────────┬───────────────────┘  │ │
│  └───────────────────┼──────────────────────┘ │
│                      │                         │
│  ┌───────────────────▼──────────────────────┐ │
│  │         O2IMS Resources                  │ │
│  │  ┌─────────────┐  ┌─────────────────┐  │ │
│  │  │   OCloud    │  │  TemplateInfo   │  │ │
│  │  └─────────────┘  └─────────────────┘  │ │
│  │  ┌────────────────────────────────────┐ │ │
│  │  │    ProvisioningRequest CR         │ │ │
│  │  └────────────────┬───────────────────┘ │ │
│  └───────────────────┼──────────────────────┘ │
│                      │                         │
│  ┌───────────────────▼──────────────────────┐ │
│  │    Edge Cluster Kubeconfig Secret        │ │
│  └───────────────────┬──────────────────────┘ │
└──────────────────────┼─────────────────────────┘
                       │
                       │ Provisions workloads
                       │
┌──────────────────────▼─────────────────────────┐
│              Edge Cluster (VM-2)               │
│                172.16.4.45                     │
│                                                │
│  ┌──────────────────────────────────────────┐ │
│  │         5G RAN Workloads                 │ │
│  │  ┌──────────┐  ┌──────────┐            │ │
│  │  │    DU    │  │    CU    │            │ │
│  │  └──────────┘  └──────────┘            │ │
│  └──────────────────────────────────────────┘ │
└─────────────────────────────────────────────────┘
```

## Components

### 1. Main Script (`p0.4A_ocloud_provision.sh`)

**Features:**
- **Strict Error Handling**: Uses `set -euo pipefail` for fail-fast behavior
- **Idempotent Operations**: Can be safely re-run without side effects
- **Comprehensive Logging**: JSON-formatted logs for machine parsing
- **Cleanup on Failure**: Automatic resource cleanup with configurable behavior
- **Progress Monitoring**: Real-time status updates with formatted tables
- **Timeout Management**: Configurable timeouts with graceful handling
- **Dry-Run Support**: Test execution without applying changes

**Key Functions:**
- `check_prerequisites()`: Validates required tools and configurations
- `create_kind_cluster()`: Creates or reuses KinD cluster with proper configuration
- `deploy_focom_operator()`: Deploys FoCoM operator using kpt
- `create_edge_cluster_secret()`: Creates kubeconfig secret for edge cluster access
- `apply_ocloud_crs()`: Applies OCloud, TemplateInfo, and ProvisioningRequest CRs
- `wait_for_provisioning()`: Monitors provisioning with timeout and status display
- `generate_documentation()`: Creates detailed documentation of deployment

### 2. Sample Manifests

#### OCloud CR (`samples/ocloud/ocloud.yaml`)
Defines the edge O-Cloud with:
- Cluster endpoints and authentication
- Capacity specifications
- Compliance metadata
- Security configuration

#### TemplateInfo CR (`samples/ocloud/template-info.yaml`)
Specifies deployment template with:
- Parameterized configuration
- Resource requirements
- Target cluster selection criteria
- Service mesh and observability settings

#### ProvisioningRequest CR (`samples/ocloud/provisioning-request.yaml`)
Triggers workload deployment with:
- Template and cluster references
- Parameter overrides
- SLA requirements
- Lifecycle hooks
- Monitoring configuration

### 3. Automation Tools

#### Makefile
Provides convenient targets for:
- Running provisioning steps
- Checking status
- Viewing logs
- Cleanup operations
- Configuration validation

#### Test Script (`test_p0.4A.sh`)
Validates:
- Script syntax and structure
- Function definitions
- Manifest validity
- Tool availability
- Dry-run execution

## Usage

### Basic Provisioning
```bash
# Run the full provisioning workflow
./scripts/p0.4A_ocloud_provision.sh

# Or use the Makefile
cd scripts
make ocloud
```

### Advanced Options
```bash
# Verbose mode with custom timeout
./scripts/p0.4A_ocloud_provision.sh --verbose --timeout 900

# Dry-run to validate setup
./scripts/p0.4A_ocloud_provision.sh --dry-run

# Skip KinD cluster creation (use existing)
./scripts/p0.4A_ocloud_provision.sh --skip-kind

# Custom edge IP
./scripts/p0.4A_ocloud_provision.sh --edge-ip 10.0.0.100
```

### Using Makefile
```bash
# Run all provisioning steps
make all

# Check status
make status

# View logs
make logs

# Clean up resources
make clean

# Validate prerequisites
make validate
```

## Configuration

### Environment Variables
```bash
export SMO_CLUSTER_NAME="focom-smo"
export SMO_KUBECONFIG="/tmp/focom-kubeconfig"
export EDGE_KUBECONFIG="/tmp/kubeconfig-edge.yaml"
export O2IMS_NAMESPACE="o2ims"
export FOCOM_NAMESPACE="focom-system"
export VM2_IP="172.16.4.45"
export TIMEOUT="600"
```

### Prerequisites
- kubectl (Kubernetes CLI)
- kind (Kubernetes in Docker)
- kpt (Package management)
- jq (JSON processor)
- yq (YAML processor)
- Valid edge cluster kubeconfig

## Monitoring

### Real-time Status
```bash
# Watch provisioning progress
watch -n 2 "kubectl --kubeconfig=/tmp/focom-kubeconfig \
  get ocloud,provisioningrequest,cluster -n o2ims"
```

### Status Table Output
```
═══ Resource Status ═══
RESOURCE                      TYPE            STATUS              MESSAGE
────────                      ────            ──────              ───────
edge-5g-deployment           ProvisioningReq  InProgress          Creating workload resources
edge-ocloud-pv-1             PackageVariant   Ready               Package rendered successfully
edge-ocloud                  Cluster          Provisioning        Applying workload manifests
```

## Troubleshooting

### Common Issues

1. **Prerequisites Not Met**
   ```bash
   # Install missing tools
   snap install kubectl --classic
   snap install kpt
   brew install kind jq yq  # On macOS
   ```

2. **Edge Cluster Not Reachable**
   ```bash
   # Verify kubeconfig
   kubectl --kubeconfig=/tmp/kubeconfig-edge.yaml cluster-info
   
   # Check connectivity
   curl -k https://172.16.4.45:6443/healthz
   ```

3. **Provisioning Stuck**
   ```bash
   # Check FoCoM operator logs
   kubectl --kubeconfig=/tmp/focom-kubeconfig \
     logs -n focom-system -l app.kubernetes.io/name=focom-operator
   
   # View events
   kubectl --kubeconfig=/tmp/focom-kubeconfig \
     get events -n o2ims --sort-by='.lastTimestamp'
   ```

4. **Resource Capacity Issues**
   ```bash
   # Check edge cluster resources
   kubectl --kubeconfig=/tmp/kubeconfig-edge.yaml \
     top nodes
   
   # Adjust replica counts in provisioning-request.yaml
   ```

## Security Considerations

1. **Kubeconfig Management**
   - Secrets stored securely in cluster
   - No plaintext credentials in scripts
   - Proper RBAC permissions

2. **Network Security**
   - TLS verification enabled
   - Network policies applied
   - Service mesh with mTLS

3. **Image Security**
   - Signed container images (when Sigstore is enabled)
   - Image scanning in CI/CD
   - Admission control policies

## Best Practices

1. **Idempotency**
   - All operations are idempotent
   - Safe to re-run on failures
   - Proper state checking

2. **Error Handling**
   - Comprehensive error checking
   - Meaningful exit codes
   - Automatic cleanup on failure

3. **Observability**
   - Structured logging
   - Metrics collection
   - Distributed tracing

4. **GitOps Ready**
   - Declarative configuration
   - Version controlled manifests
   - Automated reconciliation

## Integration Points

### With Nephio R5
- Compatible with Nephio package management
- Uses kpt for package rendering
- Supports Porch API integration

### With O-RAN O2 IMS
- Implements ProvisioningRequest spec
- Supports O2 IMS Performance API
- Ready for Measurement Job Query integration

### With GitOps Workflows
- Git-stored configurations
- ArgoCD/Flux compatible
- Automated sync and rollback

## Next Steps

1. **Enable Sigstore Integration**
   - Sign workload images
   - Verify signatures in admission
   - Policy enforcement with Kyverno

2. **Add SLO Monitoring**
   - Deploy Prometheus stack
   - Configure SLO rules
   - Implement automated gates

3. **Implement A1/E2 Interfaces**
   - Add policy management
   - Enable E2 node connections
   - RIC integration

4. **Multi-cluster Support**
   - Federation setup
   - Cross-cluster networking
   - Global load balancing

## References

- [Nephio R5 Documentation](https://nephio.org/docs)
- [O-RAN O2 IMS Specification](https://www.o-ran.org/specifications)
- [FoCoM Operator Documentation](https://github.com/nephio-project/focom)
- [KinD Documentation](https://kind.sigs.k8s.io/)
- [Kpt Documentation](https://kpt.dev/)

## Support

For issues or questions:
1. Check the troubleshooting section
2. Review logs with `make logs`
3. Validate prerequisites with `make validate`
4. Run tests with `./test_p0.4A.sh`

---
*Generated for Nephio Intent to O2 Demo - P0.4A Implementation*