# Configuration Validation CI/CD Pipeline
#
# æ­¤å·¥ä½œæµç¨‹ç¢ºä¿æ¬Šå¨é…ç½®æ–‡ä»¶çš„æ ¼å¼æ­£ç¢ºæ€§å’Œä¸€è‡´æ€§
# é˜²æ­¢å› é…ç½®éŒ¯èª¤å°Žè‡´çš„ç³»çµ±æ•…éšœ

name: Configuration Validation

on:
  push:
    paths:
      - 'config/**'
      - 'scripts/**'
      - 'examples/**'
  pull_request:
    paths:
      - 'config/**'
      - 'scripts/**'
      - 'examples/**'
  workflow_dispatch:

jobs:
  yaml-validation:
    name: YAML Configuration Validation
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pyyaml requests jsonschema

    - name: Install yq
      run: |
        sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
        sudo chmod +x /usr/local/bin/yq

    - name: Validate YAML syntax
      run: |
        echo "ðŸ” é©—è­‰ YAML èªžæ³•..."
        find config/ -name "*.yaml" -o -name "*.yml" | while read file; do
          echo "æª¢æŸ¥: $file"
          python -c "
import yaml
import sys
try:
    with open('$file', 'r') as f:
        yaml.safe_load(f)
    print('âœ… $file - YAML æ ¼å¼æ­£ç¢º')
except yaml.YAMLError as e:
    print('âŒ $file - YAML æ ¼å¼éŒ¯èª¤: {e}')
    sys.exit(1)
except Exception as e:
    print('âŒ $file - è®€å–éŒ¯èª¤: {e}')
    sys.exit(1)
"
        done

    - name: Validate configuration schema
      run: |
        echo "ðŸ” é©—è­‰é…ç½®æž¶æ§‹..."
        python examples/config_reader.py || exit 1

    - name: Test configuration loading
      run: |
        echo "ðŸ” æ¸¬è©¦é…ç½®è¼‰å…¥..."
        cd scripts
        bash load_config.sh || exit 1

    - name: Validate site endpoints
      run: |
        echo "ðŸ” é©—è­‰ç«™é»žç«¯é»žé…ç½®..."
        python -c "
from examples.config_reader import EdgeSiteConfig
import sys

try:
    config = EdgeSiteConfig()

    # æª¢æŸ¥å¿…è¦çš„ç«™é»žé…ç½®
    required_sites = ['edge1', 'edge2']
    for site in required_sites:
        try:
            slo_url = config.get_slo_endpoint(site)
            health_url = config.get_health_check_url(site)
            print(f'âœ… {site}: SLO={slo_url}, Health={health_url}')
        except Exception as e:
            print(f'âŒ {site}: é…ç½®éŒ¯èª¤ - {e}')
            sys.exit(1)

    # æª¢æŸ¥é–¾å€¼é…ç½®
    thresholds = config.get_slo_thresholds()
    required_thresholds = ['latency_p95_ms', 'success_rate_min', 'throughput_p95_mbps']
    for threshold in required_thresholds:
        if threshold not in thresholds:
            print(f'âŒ ç¼ºå°‘é–¾å€¼é…ç½®: {threshold}')
            sys.exit(1)
        print(f'âœ… é–¾å€¼ {threshold}: {thresholds[threshold]}')

    print('âœ… æ‰€æœ‰é…ç½®é©—è­‰é€šéŽ')

except Exception as e:
    print(f'âŒ é…ç½®é©—è­‰å¤±æ•—: {e}')
    sys.exit(1)
"

  script-validation:
    name: Script Validation
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y shellcheck bc

    - name: Validate shell scripts
      run: |
        echo "ðŸ” é©—è­‰ Shell è…³æœ¬èªžæ³•..."
        find scripts/ -name "*.sh" | while read script; do
          echo "æª¢æŸ¥: $script"
          if shellcheck "$script"; then
            echo "âœ… $script - Shell èªžæ³•æ­£ç¢º"
          else
            echo "âŒ $script - Shell èªžæ³•éŒ¯èª¤"
            exit 1
          fi
        done

    - name: Test script executability
      run: |
        echo "ðŸ” æ¸¬è©¦è…³æœ¬å¯åŸ·è¡Œæ€§..."
        for script in scripts/load_config.sh scripts/postcheck_v2.sh; do
          if [[ -x "$script" ]]; then
            echo "âœ… $script - å¯åŸ·è¡Œ"
          else
            echo "âŒ $script - ä¸å¯åŸ·è¡Œ"
            exit 1
          fi
        done

  integration-test:
    name: Integration Test
    runs-on: ubuntu-latest
    needs: [yaml-validation, script-validation]

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pyyaml requests
        sudo apt-get update
        sudo apt-get install -y bc jq

    - name: Install yq
      run: |
        sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
        sudo chmod +x /usr/local/bin/yq

    - name: Test configuration integration
      run: |
        echo "ðŸ” æ¸¬è©¦é…ç½®æ•´åˆ..."

        # æ¸¬è©¦é…ç½®è¼‰å…¥
        cd scripts
        source load_config.sh

        # é©—è­‰è®Šé‡æ˜¯å¦æ­£ç¢ºè¨­ç½®
        if [[ -z "${SITES[@]:-}" ]]; then
          echo "âŒ SITES é…ç½®æœªè¼‰å…¥"
          exit 1
        fi

        if [[ -z "${O2IMS_SITES[@]:-}" ]]; then
          echo "âŒ O2IMS_SITES é…ç½®æœªè¼‰å…¥"
          exit 1
        fi

        echo "âœ… é…ç½®è®Šé‡è¼‰å…¥æˆåŠŸ"
        echo "âœ… ç«™é»žæ•¸é‡: ${#SITES[@]}"

        # æ¸¬è©¦ postcheck_v2.sh çš„é…ç½®è¼‰å…¥ï¼ˆä¹¾è·‘ï¼‰
        echo "ðŸ” æ¸¬è©¦ postcheck_v2.sh é…ç½®è¼‰å…¥..."
        timeout 10 bash postcheck_v2.sh --dry-run 2>/dev/null || echo "âœ… postcheck_v2.sh é…ç½®è¼‰å…¥æ¸¬è©¦å®Œæˆ"

  report-generation:
    name: Generate Validation Report
    runs-on: ubuntu-latest
    needs: [yaml-validation, script-validation, integration-test]
    if: always()

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Generate validation report
      run: |
        echo "ðŸ“Š ç”Ÿæˆé©—è­‰å ±å‘Š..."

        cat > validation-report.md << 'EOF'
# Configuration Validation Report

**æ—¥æœŸ**: $(date)
**æäº¤**: ${{ github.sha }}
**åˆ†æ”¯**: ${{ github.ref_name }}

## é©—è­‰çµæžœ

| æª¢æŸ¥é …ç›® | ç‹€æ…‹ | èªªæ˜Ž |
|---------|------|------|
| YAML èªžæ³• | ${{ needs.yaml-validation.result == 'success' && 'âœ… é€šéŽ' || 'âŒ å¤±æ•—' }} | é…ç½®æ–‡ä»¶èªžæ³•æª¢æŸ¥ |
| è…³æœ¬èªžæ³• | ${{ needs.script-validation.result == 'success' && 'âœ… é€šéŽ' || 'âŒ å¤±æ•—' }} | Shell è…³æœ¬èªžæ³•æª¢æŸ¥ |
| æ•´åˆæ¸¬è©¦ | ${{ needs.integration-test.result == 'success' && 'âœ… é€šéŽ' || 'âŒ å¤±æ•—' }} | é…ç½®è¼‰å…¥å’Œæ•´åˆæ¸¬è©¦ |

## é…ç½®æª”æ¡ˆç‹€æ…‹

- `config/edge-sites-config.yaml`: æ¬Šå¨é…ç½®æ–‡ä»¶
- `scripts/load_config.sh`: é…ç½®è¼‰å…¥å™¨
- `scripts/postcheck_v2.sh`: é…ç½®é©…å‹•çš„ postcheck è…³æœ¬
- `examples/config_reader.py`: Python é…ç½®è®€å–å™¨

## å»ºè­°è¡Œå‹•

${{ needs.yaml-validation.result == 'success' && needs.script-validation.result == 'success' && needs.integration-test.result == 'success' && 'âœ… æ‰€æœ‰æª¢æŸ¥é€šéŽï¼Œå¯ä»¥åˆä½µ' || 'âŒ å­˜åœ¨å•é¡Œï¼Œéœ€è¦ä¿®å¾©å¾Œå†æ¬¡æäº¤' }}

EOF

        echo "âœ… é©—è­‰å ±å‘Šå·²ç”Ÿæˆ"

    - name: Upload validation report
      uses: actions/upload-artifact@v4
      with:
        name: validation-report
        path: validation-report.md